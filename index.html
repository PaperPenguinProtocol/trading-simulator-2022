<!doctype html>
<html>
	<head>
		<meta charset="utf-8">
		<title>Stock simulation test</title>
		<meta name="viewport" content="width=device-width,initial-scale=1">
		<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
		<script>
			helpers = {
				sign: () => (Math.round(Math.random()) * 2 - 1),
				color: (fraction) => {
					const width = 0.3
					const other = (fraction < width ? fraction + 1 : fraction - 1)
					const o = (l, f) => (Math.min(f + width, l + 1/3) - Math.max(f - width, l))
					const overlap = (l) => (255 * 3 * Math.max(0, Math.max(o(l, fraction), o(l, other))))
					return "rgb(" + Math.round(overlap(0)) + ", " + Math.round(overlap(1/3)) + ", " + Math.round(overlap(2/3)) + ")"
				},
			}

			news = {
				basic: () => (helpers.sign() * Math.random() * 0.1),
				infrequent: () => {
					const r = Math.random()
					if (r < 0.89) return 0
					const s = helpers.sign()
					if (r < 0.96) return s * Math.random() * (s == 1 ? 0.2 : 0.1)
					return s * Math.pow(Math.random(), (s == 1 ? 5 : 7))
				},
				crazy: () => {
					const s = helpers.sign()
					return s * Math.pow(Math.random(), (s == 1 ? 1.5 : 2)) * 0.5
				},
				realistic: () => {
					const r = Math.random()
					let result
					if (Math.random() < 0.5) result = -0.1 * Math.pow(r, 3.5) - 0.4 * Math.pow(r, 10000)
					else result = 0.1 * Math.pow(r, 3) + 1.9 * Math.pow(r, 10000)
					if (Math.abs(result) < 0.03) return 0
					return result
				},
			}

			iterate = (news, price, pressure) => {
				const initialPrice = price
				pressure += price * news
				const rawPrice = price + pressure * 0.8
				pressure -= rawPrice - price
				const s = helpers.sign()
				const noise = s * Math.pow(Math.random(), (s == 1 ? 0.4 : 0.5))
				price = rawPrice + noise * Math.max(Math.abs(rawPrice - price) * 0.2, rawPrice * 0.02)
				pressure -= price - rawPrice
				pressure *= price / initialPrice
				return { price, pressure }
			}

			generate = (newsFunction) => {
				if ("destroy" in chart) chart.destroy()
				const daysCount = 1000
				const companies = [ "A", "B", "C", "D", "E", "F" ]
				const companyProperties = companies.map((name) => ({
					priceHistory: [],
					price: Math.random() * 90 + 10,
					pressure: 0,
				}))
				yesterdaysNews = companies.map((name) => 0)
				for (let i = 0; i < daysCount; i++) {
					for (let j = 0; j < companies.length; j++) {
						let c = companyProperties[j]
						const results = iterate(yesterdaysNews[j], c.price, c.pressure)
						c.priceHistory.push(results.price)
						c.price = results.price
						c.pressure = results.pressure
					}
					yesterdaysNews = companies.map((name) => newsFunction())
				}
				const config = {
					type: "line",
					data: {
						labels: Array.from(new Array(daysCount), (v, i) => i),
						datasets: companies.map((name, index) => ({
							label: name,
							borderColor: helpers.color(index / companies.length),
							data: companyProperties[index].priceHistory,
						})),
					},
					options: { scales: { y: { min: 0 } }, animation: false, spanGaps: true, elements: { point: { radius: 0 } } },
				}
				chart = new Chart(document.getElementById("chart"), config)
			}
		</script>
	</head>
	<body>
		<div>
			<h1>Generate new</h1>
			<button onclick="generate(news.basic)">Basic news</button>
			<button onclick="generate(news.infrequent)">Infrequent news</button>
			<button onclick="generate(news.crazy)">Crazy news</button>
			<button onclick="generate(news.realistic)">Realistic news</button>
		</div>
		<div>
			<h1>Chart</h1>
			<canvas id="chart"></canvas>
		</div>
	</body>
</html>
